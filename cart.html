<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>장바구니 - VAPING ALL </title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
        .cart-container { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-top: 0; }
        
        .cart-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .cart-item img { width: 70px; height: 70px; border-radius: 8px; margin-right: 15px; object-fit: cover; }
        .item-info { flex-grow: 1; }
        .item-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .item-price { color: #888; font-size: 14px; }
        
        .total-section { margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; text-align: right; }
        .total-label { font-size: 16px; color: #555; }
        .total-price { font-size: 24px; font-weight: bold; color: #ff4757; display: block; margin-top: 5px; }
        
        .btn-group { margin-top: 30px; display: flex; gap: 10px; }
        .btn { flex: 1; height: 55px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-order { background: #000; color: #fff; }
        .btn-shop { background: #eee; color: #333; }
        .btn:hover { opacity: 0.8; }
        
        .remove-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 12px; text-decoration: underline; }
        .remove-btn:hover { color: red; }
    </style>
</head>
<body>

    <div class="cart-container">
        <h2>장바구니</h2>
        
        <div id="cart-list"></div>

        <div class="total-section">
            <span class="total-label">총 결제 금액</span>
            <span class="total-price" id="total-amount">0원</span>
        </div>

        <div class="btn-group">
            <button class="btn btn-shop" onclick="location.href='index.html'">쇼핑 계속하기</button>
            <button class="btn btn-order" onclick="checkout()">주문하기</button>
        </div>
    </div>

    <script>
        // 1. 장바구니 화면 그리기
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('myCart')) || [];
            const listElement = document.getElementById('cart-list');
            let total = 0;

            if (cart.length === 0) {
                listElement.innerHTML = "<p style='text-align:center; padding: 40px 0; color:#999;'>장바구니가 비어 있습니다.</p>";
                document.getElementById('total-amount').innerText = "0원";
                return;
            }

            listElement.innerHTML = cart.map((item, index) => {
                total += (Number(item.price) * item.qty);
                return `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/70?text=No+Image'">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">${Number(item.price).toLocaleString()}원 x ${item.qty}개</div>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${index})">삭제</button>
                    </div>
                `;
            }).join('');

            document.getElementById('total-amount').innerText = total.toLocaleString() + "원";
        }

        // 2. 상품 삭제 기능
        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('myCart')) || [];
            cart.splice(index, 1); // 해당 순서 상품 제거
            localStorage.setItem('myCart', JSON.stringify(cart));
            renderCart(); // 다시 그리기
        }

        // 3. ★ 핵심: 주문하기 (로그인 체크 강화) ★
        function checkout() {
            // [로그인 체크] 세션에 유저 정보가 있는지 확인
            const loggedInUser = sessionStorage.getItem('loginUser');

            if (!loggedInUser) {
                alert("성인 인증이 필요한 상품이 포함되어 있습니다.\n로그인(회원가입) 후 구매해 주세요.");
                location.href = 'index.html'; // 메인 페이지로 이동
                return; // 결제창 실행을 중단함
            }

            const cart = JSON.parse(localStorage.getItem('myCart')) || [];
            if (cart.length === 0) return alert("장바구니가 비어 있습니다.");

            // 총 금액 계산
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const orderName = cart.length > 1 ? `${cart[0].name} 외 ${cart.length - 1}건` : cart[0].name;

            // 토스페이먼츠 결제창 호출
            const tossPayments = TossPayments('test_ck_D5bZzMfa5noR9nXykmVn3W4n14uD');
            tossPayments.requestPayment('카드', {
                amount: totalAmount,
                orderId: 'cart-' + new Date().getTime(),
                orderName: orderName,
                successUrl: window.location.origin,
                failUrl: window.location.origin,
            });
        }

        // 페이지 열리자마자 장바구니 목록 로드
        renderCart();
    </script>
</body>
</html>